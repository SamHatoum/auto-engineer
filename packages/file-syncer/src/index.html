<!doctype html>
<html>
  <head>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/@isomorphic-git/lightning-fs"></script>
  </head>
  <body>
    <h1>Two-Way File Sync</h1>
    <div id="status"></div>
    <br />
    <input type="file" id="upload" multiple />
    <button onclick="deleteFile()">Delete File</button>
    <input type="text" id="deletePath" placeholder="path/to/file.js" />

    <script>
      const fs = new LightningFS('fs');
      const socket = io('http://localhost:3000');

      socket.on('file-change', async (data) => {
        const fullPath = '/' + data.path;

        if (data.event === 'delete') {
          await fs.promises.unlink(fullPath).catch(() => {});
          document.getElementById('status').innerHTML += `<div>Deleted: ${data.path}</div>`;
        } else {
          const dir = fullPath.substring(0, fullPath.lastIndexOf('/'));
          if (dir) {
            await fs.promises.mkdir(dir, { recursive: true }).catch(() => {});
          }

          const content = Uint8Array.from(atob(data.content), (c) => c.charCodeAt(0));
          await fs.promises.writeFile(fullPath, content);
          document.getElementById('status').innerHTML += `<div>${data.event}: ${data.path} ${new TextDecoder('utf-8').decode(content)}</div>`;
        }
      });

      async function sendFile(path, content) {
        const base64 = btoa(String.fromCharCode(...content));
        socket.emit('client-file-change', {
          event: 'write',
          path: path.startsWith('/') ? path.slice(1) : path,
          content: base64,
        });
      }

      async function deleteFile() {
        const path = document.getElementById('deletePath').value;
        if (!path) return;

        const fullPath = '/' + path;
        await fs.promises.unlink(fullPath).catch(() => {});
        socket.emit('client-file-change', {
          event: 'delete',
          path: path,
        });
        document.getElementById('status').innerHTML += `<div>Client deleted: ${path}</div>`;
      }

      document.getElementById('upload').addEventListener('change', async (e) => {
        for (const file of e.target.files) {
          const content = new Uint8Array(await file.arrayBuffer());
          const path = file.name;

          await fs.promises.writeFile('/' + path, content);

          sendFile(path, content);
          document.getElementById('status').innerHTML += `<div>Client uploaded: ${path}</div>`;
        }
      });

      window.fs = fs;
      window.sendFile = sendFile;
    </script>
  </body>
</html>
