{
  "variant": "specs",
  "flows": [
    {
      "name": "Questionnaires",
      "slices": [
        {
          "name": "views the questionnaire",
          "type": "query",
          "client": {
            "description": "",
            "specs": {
              "name": "",
              "rules": [
                "focus on the current question based on the progress state",
                "display the list of answered questions",
                "display the list of remaining questions",
                "show a progress indicator that is always visible as the user scrolls"
              ]
            }
          },
          "request": "query QuestionnaireProgress($participantId: ID!) {\n  questionnaireProgress(participantId: $participantId) {\n    questionnaireId\n    participantId\n    status\n    currentQuestionId\n    remainingQuestions\n    answers {\n      questionId\n      value\n    }\n  }\n}",
          "server": {
            "description": "",
            "data": [
              {
                "target": {
                  "type": "State",
                  "name": "QuestionnaireProgress"
                },
                "origin": {
                  "type": "projection",
                  "name": "Questionnaires",
                  "idField": "questionnaire-participantId"
                }
              }
            ],
            "specs": {
              "name": "",
              "rules": [
                {
                  "description": "questionnaires show current progress",
                  "examples": [
                    {
                      "description": "a question has already been answered",
                      "given": [
                        {
                          "eventRef": "QuestionAnswered",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "link": "https://app.example.com/q/q-001?participant=participant-abc",
                            "sentAt": "2030-01-01T09:00:00.000Z"
                          }
                        },
                        {
                          "eventRef": "QuestionAnswered",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "questionId": "q1",
                            "answer": "Yes",
                            "savedAt": "2030-01-01T09:05:00.000Z"
                          }
                        }
                      ],
                      "when": {
                        "exampleData": {},
                        "eventRef": "QuestionnaireLinkSent"
                      },
                      "then": [
                        {
                          "stateRef": "QuestionnaireProgress",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "status": "in_progress",
                            "currentQuestionId": "q2",
                            "remainingQuestions": ["q2", "q3"],
                            "answers": [
                              {
                                "questionId": "q1",
                                "value": "Yes"
                              }
                            ]
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "name": "submits a questionnaire answer",
          "type": "command",
          "client": {
            "description": "",
            "specs": {
              "name": "",
              "rules": [
                "display a success message when the answer is submitted",
                "display an error message when the answer submission is rejected"
              ]
            }
          },
          "request": "mutation AnswerQuestion($input: AnswerQuestionInput!) {\n  answerQuestion(input: $input) {\n    success\n  }\n}",
          "server": {
            "description": "",
            "data": [
              {
                "target": {
                  "type": "Event",
                  "name": "QuestionAnswered"
                },
                "destination": {
                  "type": "stream",
                  "pattern": "questionnaire-participantId"
                }
              },
              {
                "target": {
                  "type": "Event",
                  "name": "QuestionnaireEditRejected"
                },
                "destination": {
                  "type": "stream",
                  "pattern": "questionnaire-participantId"
                }
              }
            ],
            "specs": {
              "name": "",
              "rules": [
                {
                  "description": "answers are allowed while the questionnaire has not been submitted",
                  "examples": [
                    {
                      "description": "no questions have been answered yet",
                      "when": {
                        "commandRef": "AnswerQuestion",
                        "exampleData": {
                          "questionnaireId": "q-001",
                          "participantId": "participant-abc",
                          "questionId": "q1",
                          "answer": "Yes"
                        }
                      },
                      "then": [
                        {
                          "eventRef": "QuestionAnswered",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "questionId": "q1",
                            "answer": "Yes",
                            "savedAt": "2030-01-01T09:05:00.000Z"
                          }
                        }
                      ]
                    },
                    {
                      "description": "all questions have already been answered and submitted",
                      "given": [
                        {
                          "eventRef": "QuestionnaireLinkSent",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "submittedAt": "2030-01-01T09:00:00.000Z"
                          }
                        }
                      ],
                      "when": {
                        "commandRef": "AnswerQuestion",
                        "exampleData": {
                          "questionnaireId": "q-001",
                          "participantId": "participant-abc",
                          "questionId": "q1",
                          "answer": "Yes"
                        }
                      },
                      "then": [
                        {
                          "eventRef": "QuestionnaireEditRejected",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "reason": "Questionnaire already submitted",
                            "attemptedAt": "2030-01-01T09:05:00.000Z"
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "name": "questionnaire ready for submission",
          "type": "query",
          "client": {
            "description": "",
            "specs": {
              "name": "",
              "rules": [
                "enable the submit button when all questions are answered",
                "disable the submit button when all questions have not been answered"
              ]
            }
          },
          "request": "query QuestionnaireProgress($participantId: ID!) {\n  questionnaireProgress(participantId: $participantId) {\n    questionnaireId\n    participantId\n    status\n    currentQuestionId\n    remainingQuestions\n    answers {\n      questionId\n      value\n    }\n  }\n}",
          "server": {
            "description": "",
            "data": [
              {
                "target": {
                  "type": "State",
                  "name": "QuestionnaireProgress"
                },
                "origin": {
                  "type": "projection",
                  "name": "Questionnaires",
                  "idField": "questionnaire-participantId"
                }
              },
              {
                "target": {
                  "type": "State",
                  "name": "QuestionnaireConfig"
                },
                "origin": {
                  "type": "database",
                  "collection": "QuestionnaireConfigAPI"
                }
              }
            ],
            "specs": {
              "name": "",
              "rules": [
                {
                  "description": "questionnaire is ready for submission when all questions are answered",
                  "examples": [
                    {
                      "description": "all questions have been answered",
                      "given": [
                        {
                          "eventRef": "QuestionnaireSubmitted",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "numberOfQuestions": 2
                          }
                        },
                        {
                          "eventRef": "QuestionnaireLinkSent",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "link": "https://app.example.com/q/q-001?participant=participant-abc",
                            "sentAt": "2030-01-01T09:00:00.000Z"
                          }
                        },
                        {
                          "eventRef": "QuestionAnswered",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "questionId": "q1",
                            "answer": "Yes",
                            "savedAt": "2030-01-01T09:05:00.000Z"
                          }
                        },
                        {
                          "eventRef": "QuestionAnswered",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "questionId": "q2",
                            "answer": "No",
                            "savedAt": "2030-01-01T09:05:00.000Z"
                          }
                        }
                      ],
                      "when": {
                        "exampleData": {},
                        "eventRef": "QuestionnaireLinkSent"
                      },
                      "then": [
                        {
                          "stateRef": "QuestionnaireProgress",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "status": "ready_to_submit",
                            "currentQuestionId": null,
                            "remainingQuestions": [],
                            "answers": [
                              {
                                "questionId": "q1",
                                "value": "Yes"
                              },
                              {
                                "questionId": "q2",
                                "value": "No"
                              }
                            ]
                          }
                        }
                      ]
                    },
                    {
                      "description": "some questions are still unanswered",
                      "given": [
                        {
                          "eventRef": "QuestionAnswered",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "link": "https://app.example.com/q/q-001?participant=participant-abc",
                            "sentAt": "2030-01-01T09:00:00.000Z"
                          }
                        },
                        {
                          "eventRef": "QuestionAnswered",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "questionId": "q1",
                            "answer": "Yes",
                            "savedAt": "2030-01-01T09:05:00.000Z"
                          }
                        }
                      ],
                      "when": {
                        "exampleData": {},
                        "eventRef": "QuestionnaireLinkSent"
                      },
                      "then": [
                        {
                          "stateRef": "QuestionnaireProgress",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "status": "in_progress",
                            "currentQuestionId": "q2",
                            "remainingQuestions": ["q2", "q3"],
                            "answers": [
                              {
                                "questionId": "q1",
                                "value": "Yes"
                              }
                            ]
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        },
        {
          "name": "submits the questionnaire",
          "type": "command",
          "client": {
            "description": "",
            "specs": {
              "name": "",
              "rules": ["display a confirmation message upon successful submission"]
            }
          },
          "request": "mutation SubmitQuestionnaire($input: SubmitQuestionnaireInput!) {\n  submitQuestionnaire(input: $input) {\n    success\n  }\n}",
          "server": {
            "description": "",
            "data": [
              {
                "target": {
                  "type": "Event",
                  "name": "QuestionnaireSubmitted"
                },
                "destination": {
                  "type": "stream",
                  "pattern": "questionnaire-participantId"
                }
              }
            ],
            "specs": {
              "name": "",
              "rules": [
                {
                  "description": "questionnaire allowed to be submitted when all questions are answered",
                  "examples": [
                    {
                      "description": "submits the questionnaire successfully",
                      "when": {
                        "commandRef": "SubmitQuestionnaire",
                        "exampleData": {
                          "questionnaireId": "q-001",
                          "participantId": "participant-abc"
                        }
                      },
                      "then": [
                        {
                          "eventRef": "QuestionnaireSubmitted",
                          "exampleData": {
                            "questionnaireId": "q-001",
                            "participantId": "participant-abc",
                            "submittedAt": "2030-01-01T09:00:00.000Z"
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          }
        }
      ],
      "sourceFile": "/Users/ramihatoum/WebstormProjects/xolvio/auto-engineer/examples/questionnaires/flows/questionnaires.flow.ts"
    }
  ],
  "messages": [
    {
      "type": "event",
      "name": "QuestionAnswered",
      "fields": [
        {
          "name": "questionnaireId",
          "type": "string",
          "required": true
        },
        {
          "name": "participantId",
          "type": "string",
          "required": true
        },
        {
          "name": "questionId",
          "type": "string",
          "required": true
        },
        {
          "name": "answer",
          "type": "unknown",
          "required": true
        },
        {
          "name": "savedAt",
          "type": "Date",
          "required": true
        }
      ],
      "source": "internal",
      "metadata": {
        "version": 1
      }
    },
    {
      "type": "event",
      "name": "QuestionnaireLinkSent",
      "fields": [
        {
          "name": "questionnaireId",
          "type": "string",
          "required": true
        },
        {
          "name": "participantId",
          "type": "string",
          "required": true
        },
        {
          "name": "link",
          "type": "string",
          "required": true
        },
        {
          "name": "sentAt",
          "type": "Date",
          "required": true
        }
      ],
      "source": "internal",
      "metadata": {
        "version": 1
      }
    },
    {
      "type": "state",
      "name": "QuestionnaireProgress",
      "fields": [
        {
          "name": "questionnaireId",
          "type": "string",
          "required": true
        },
        {
          "name": "participantId",
          "type": "string",
          "required": true
        },
        {
          "name": "status",
          "type": "\"in_progress\" | \"ready_to_submit\" | \"submitted\"",
          "required": true
        },
        {
          "name": "currentQuestionId",
          "type": "string | null",
          "required": true
        },
        {
          "name": "remainingQuestions",
          "type": "Array<string>",
          "required": true
        },
        {
          "name": "answers",
          "type": "Array<{ questionId: string; value: unknown }>",
          "required": true
        }
      ],
      "metadata": {
        "version": 1
      }
    },
    {
      "type": "command",
      "name": "AnswerQuestion",
      "fields": [
        {
          "name": "questionnaireId",
          "type": "string",
          "required": true
        },
        {
          "name": "participantId",
          "type": "string",
          "required": true
        },
        {
          "name": "questionId",
          "type": "string",
          "required": true
        },
        {
          "name": "answer",
          "type": "unknown",
          "required": true
        }
      ],
      "metadata": {
        "version": 1
      }
    },
    {
      "type": "event",
      "name": "QuestionnaireEditRejected",
      "fields": [
        {
          "name": "questionnaireId",
          "type": "string",
          "required": true
        },
        {
          "name": "participantId",
          "type": "string",
          "required": true
        },
        {
          "name": "reason",
          "type": "string",
          "required": true
        },
        {
          "name": "attemptedAt",
          "type": "Date",
          "required": true
        }
      ],
      "source": "internal",
      "metadata": {
        "version": 1
      }
    },
    {
      "type": "event",
      "name": "QuestionnaireSubmitted",
      "fields": [
        {
          "name": "questionnaireId",
          "type": "string",
          "required": true
        },
        {
          "name": "participantId",
          "type": "string",
          "required": true
        },
        {
          "name": "submittedAt",
          "type": "Date",
          "required": true
        }
      ],
      "source": "internal",
      "metadata": {
        "version": 1
      }
    },
    {
      "type": "command",
      "name": "SubmitQuestionnaire",
      "fields": [
        {
          "name": "questionnaireId",
          "type": "string",
          "required": true
        },
        {
          "name": "participantId",
          "type": "string",
          "required": true
        }
      ],
      "metadata": {
        "version": 1
      }
    }
  ],
  "integrations": []
}
